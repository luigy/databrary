<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Comment</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.Comment.SQL.html#selectContainerComment"><span class="hs-identifier hs-var">selectContainerComment</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Comment.SQL.html#selectComment"><span class="hs-identifier hs-var">selectComment</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Comment.SQL.html#selectCommentRow"><span class="hs-identifier hs-var">selectCommentRow</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-SQL-Select.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span class="hs-operator">.</span><span class="hs-identifier">Select</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Time.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Id-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Id</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Party-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Party</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Party-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Party</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Comment-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Comment</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Container-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Container-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Segment.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Segment</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Slot-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Slot</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-identifier">makeComment</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Comment.Types.html#Comment"><span class="hs-identifier hs-type">Comment</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Segment.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Time.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Comment.Types.html#Comment"><span class="hs-identifier hs-type">Comment</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Party.Types.html#Account"><span class="hs-identifier hs-type">Account</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Container.Types.html#Container"><span class="hs-identifier hs-type">Container</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Comment.Types.html#Comment"><span class="hs-identifier hs-type">Comment</span></a><span>
</span><a name="line-24"></a><a name="makeComment"><a href="Databrary.Model.Comment.SQL.html#makeComment"><span class="hs-identifier">makeComment</span></a></a><span> </span><a name="local-1628572076"><a href="#local-1628572076"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-1628572077"><a href="#local-1628572077"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-1628572078"><a href="#local-1628572078"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1628572079"><a href="#local-1628572079"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1628572080"><a href="#local-1628572080"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-1628572081"><a href="#local-1628572081"><span class="hs-identifier">w</span></a></a><span> </span><a name="local-1628572082"><a href="#local-1628572082"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.Comment.Types.html#Comment"><span class="hs-identifier hs-var">Comment</span></a><span> </span><a href="#local-1628572076"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-1628572081"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Slot.Types.html#Slot"><span class="hs-identifier hs-var">Slot</span></a><span> </span><a href="#local-1628572082"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-1628572077"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628572078"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1628572079"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;NULL comment thread&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628572080"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-identifier">commentRow</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.SQL.Select.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span> </span><span class="hs-comment">-- ^ @'Account' -&gt; 'Container' -&gt; 'Comment'@</span><span>
</span><a name="line-27"></a><a name="commentRow"><a href="Databrary.Model.Comment.SQL.html#commentRow"><span class="hs-identifier">commentRow</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.SQL.Select.html#selectColumns"><span class="hs-identifier hs-var">selectColumns</span></a><span> </span><span class="hs-char">'makeComment &quot;comment&quot; [&quot;id&quot;, &quot;segment&quot;, &quot;time&quot;, &quot;text&quot;, &quot;thread&quot;]

selectAccountContainerComment :: Selector -- ^ @'Account' -&gt; 'Container' -&gt; 'Comment'@
selectAccountContainerComment = fromMap (&quot;comment_thread AS &quot; ++) commentRow

selectContainerComment :: TH.Name -- ^ @'Identity'@
  -&gt; Selector -- ^ @'Container' -&gt; 'Comment'@
selectContainerComment ident = selectJoin '($)
  [ selectAccountContainerComment
  , joinOn &quot;comment.who = account.id&quot;
    $ selectAccount ident
  ]

selectComment :: TH.Name -- ^ @'Identity'@
  -&gt; Selector -- ^ @'Comment'@
selectComment ident = selectJoin '($)
  [ selectContainerComment ident
  , joinOn &quot;comment.container = container.id&quot;
    $ selectContainer ident
  ]

makeCommentRow :: Id Comment -&gt; Id Container -&gt; Segment -&gt; Id Party -&gt; Timestamp -&gt; T.Text -&gt; CommentRow
makeCommentRow i c s w t x = CommentRow i w (SlotId c s) t x

selectCommentRow :: Selector -- ^ @'CommentRow'@
selectCommentRow = selectColumns 'makeCommentRow &quot;comment&quot; [&quot;id&quot;, &quot;container&quot;, &quot;segment&quot;, &quot;who&quot;, &quot;time&quot;, &quot;text&quot;]

_commentSets :: String -- ^ @'Comment'@
  -&gt; [(String, String)]
_commentSets o =
  [ (&quot;who&quot;, &quot;${partyId $ accountParty $ commentWho &quot; ++ o ++ &quot;}&quot;)
  , (&quot;container&quot;, &quot;${containerId $ slotContainer $ commentSlot &quot; ++ o ++ &quot;}&quot;)
  , (&quot;segment&quot;, &quot;${slotSegment $ commentSlot &quot; ++ o ++ &quot;}&quot;)
  , (&quot;text&quot;, &quot;${commentText &quot; ++ o ++ &quot;}&quot;)
  , (&quot;parent&quot;, &quot;${listToMaybe $ commentParents &quot; ++ o ++ &quot;}&quot;)
  ]
</span></pre></body></html>