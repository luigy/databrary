<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, TemplateHaskell, TypeFamilies #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Party</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.Party.Types.html#PartyRow"><span class="hs-identifier hs-type">PartyRow</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier hs-type">Party</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Party.Types.html#Account"><span class="hs-identifier hs-type">Account</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Party.Types.html#SiteAuth"><span class="hs-identifier hs-type">SiteAuth</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Party.Types.html#nobodySiteAuth"><span class="hs-identifier hs-var">nobodySiteAuth</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Party.Types.html#blankParty"><span class="hs-identifier hs-var">blankParty</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Party.Types.html#blankAccount"><span class="hs-identifier hs-var">blankAccount</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Instances</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Lift</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Lift</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deriveLiftMany</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Has.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Has</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Has.html#makeHasRec"><span class="hs-identifier hs-var">makeHasRec</span></a><span class="hs-special">,</span><span> </span><a href="Databrary.Has.html#Has"><span class="hs-identifier hs-type">Has</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.URL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">URL</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">URI</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Kind.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Id.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Id</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Permission.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Permission</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.ORCID.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">ORCID</span></a><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><a href="Databrary.Model.Id.Types.html#IdType"><span class="hs-identifier hs-type">IdType</span></a><span> </span><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier hs-type">Party</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">data</span><span> </span><a name="PartyRow"><a href="Databrary.Model.Party.Types.html#PartyRow"><span class="hs-identifier">PartyRow</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PartyRow"><a href="Databrary.Model.Party.Types.html#PartyRow"><span class="hs-identifier">PartyRow</span></a></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="partyId"><a href="Databrary.Model.Party.Types.html#partyId"><span class="hs-identifier">partyId</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier hs-type">Party</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partySortName"><a href="Databrary.Model.Party.Types.html#partySortName"><span class="hs-identifier">partySortName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partyPreName"><a href="Databrary.Model.Party.Types.html#partyPreName"><span class="hs-identifier">partyPreName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partyORCID"><a href="Databrary.Model.Party.Types.html#partyORCID"><span class="hs-identifier">partyORCID</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.ORCID.html#ORCID"><span class="hs-identifier hs-type">ORCID</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partyAffiliation"><a href="Databrary.Model.Party.Types.html#partyAffiliation"><span class="hs-identifier">partyAffiliation</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partyURL"><a href="Databrary.Model.Party.Types.html#partyURL"><span class="hs-identifier">partyURL</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">URI</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">data</span><span> </span><a name="Party"><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier">Party</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Party"><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier">Party</span></a></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="partyRow"><a href="Databrary.Model.Party.Types.html#partyRow"><span class="hs-identifier">partyRow</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Databrary.Model.Party.Types.html#PartyRow"><span class="hs-identifier hs-type">PartyRow</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partyAccount"><a href="Databrary.Model.Party.Types.html#partyAccount"><span class="hs-identifier">partyAccount</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.Party.Types.html#Account"><span class="hs-identifier hs-type">Account</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-comment">-- , partySiteAccess :: Access -- site-level access this party is granted under root (currently SiteAuth only)</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partyPermission"><a href="Databrary.Model.Party.Types.html#partyPermission"><span class="hs-identifier">partyPermission</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Permission.Types.html#Permission"><span class="hs-identifier hs-type">Permission</span></a><span> </span><span class="hs-comment">-- permission current user has over this party</span><span>
</span><a name="line-40"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="partyAccess"><a href="Databrary.Model.Party.Types.html#partyAccess"><span class="hs-identifier">partyAccess</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.Permission.Types.html#Access"><span class="hs-identifier hs-type">Access</span></a><span> </span><span class="hs-comment">-- direct authorization this party has granted to current user</span><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">data</span><span> </span><a name="Account"><a href="Databrary.Model.Party.Types.html#Account"><span class="hs-identifier">Account</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Account"><a href="Databrary.Model.Party.Types.html#Account"><span class="hs-identifier">Account</span></a></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="accountEmail"><a href="Databrary.Model.Party.Types.html#accountEmail"><span class="hs-identifier">accountEmail</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="accountParty"><a href="Databrary.Model.Party.Types.html#accountParty"><span class="hs-identifier">accountParty</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier hs-type">Party</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><a href="Databrary.Model.Party.Types.html#partyId"><span class="hs-identifier hs-var">makeHasRec</span></a><span> </span><span class="hs-char">''PartyRow ['partyId]
makeHasRec ''Party ['partyRow]
makeHasRec ''Account ['accountParty]

instance Has Access Party where
  view Party{ partyAccess = Just a } = a
  view _ = mempty
instance Has Permission Party where
  view = partyPermission

instance Kinded Party where
  kindOf _ = &quot;party&quot;

-- Access to the site by a (current) account
data SiteAuth = SiteAuth
  { siteAccount :: Account -- maybe should be Party (for nobody)
  , accountPasswd :: Maybe BS.ByteString
  , siteAccess :: Access
  }

makeHasRec ''SiteAuth ['siteAccount, 'siteAccess]

deriveLiftMany [''PartyRow, ''Party, ''Account]

-- this is unfortunate, mainly to avoid untangling Party.SQL
nobodySiteAuth :: SiteAuth
nobodySiteAuth = SiteAuth
  { siteAccount = Account
    { accountEmail = &quot;nobody@databrary.org&quot;
    , accountParty = Party
      { partyRow = PartyRow
        { partyId = Id (-1)
        , partySortName = &quot;Nobody&quot;
        , partyPreName = Nothing
        , partyORCID = Nothing
        , partyAffiliation = Nothing
        , partyURL = Nothing
        }
      , partyAccount = Nothing
      , partyPermission = PermissionREAD
      , partyAccess = Just minBound
      }
    }
  , accountPasswd = Nothing
  , siteAccess = mempty
  }

blankParty :: Party
blankParty = Party
  { partyRow = PartyRow
    { partyId = error &quot;blankParty&quot;
    , partySortName = &quot;&quot;
    , partyPreName = Nothing
    , partyORCID = Nothing
    , partyAffiliation = Nothing
    , partyURL = Nothing
    }
  , partyAccount = Nothing
  , partyPermission = PermissionNONE
  , partyAccess = Nothing
  }

blankAccount :: Account
blankAccount = Account
  { accountParty = blankParty{ partyAccount = Just blankAccount }
  , accountEmail = error &quot;blankAccount&quot;
  }
</span></pre></body></html>