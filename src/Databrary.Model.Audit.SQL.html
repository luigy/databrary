<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, OverloadedStrings #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Audit</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.Audit.SQL.html#selectAudit"><span class="hs-identifier hs-var">selectAudit</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Audit.SQL.html#auditInsert"><span class="hs-identifier hs-var">auditInsert</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Audit.SQL.html#auditDelete"><span class="hs-identifier hs-var">auditDelete</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Audit.SQL.html#auditUpdate"><span class="hs-identifier hs-var">auditUpdate</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Audit.SQL.html#selectAuditActivity"><span class="hs-identifier hs-var">selectAuditActivity</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Audit.SQL.html#whereEq"><span class="hs-identifier hs-var">whereEq</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span class="hs-operator">.</span><span class="hs-identifier">Dynamic</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pgSafeLiteralString</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span class="hs-operator">.</span><span class="hs-identifier">Inet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PGInet</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makePGQuery</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parseQueryFlags</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-SQL-Select.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span class="hs-operator">.</span><span class="hs-identifier">Select</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Time.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Id-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Id</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Party-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Party</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Audit-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Audit</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-identifier">makeAudit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Time.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier hs-type">Party</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PGInet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Audit.Types.html#AuditAction"><span class="hs-identifier hs-type">AuditAction</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Audit.Types.html#Audit"><span class="hs-identifier hs-type">Audit</span></a><span>
</span><a name="line-25"></a><a name="makeAudit"><a href="Databrary.Model.Audit.SQL.html#makeAudit"><span class="hs-identifier">makeAudit</span></a></a><span> </span><a name="local-1628432570"><a href="#local-1628432570"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1628432571"><a href="#local-1628432571"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.Audit.Types.html#Audit"><span class="hs-identifier hs-var">Audit</span></a><span> </span><a href="#local-1628432570"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Audit.Types.html#AuditIdentity"><span class="hs-identifier hs-var">AuditIdentity</span></a><span> </span><a href="#local-1628432571"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-identifier">selectAudit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.SQL.Select.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span>
</span><a name="line-28"></a><a name="selectAudit"><a href="Databrary.Model.Audit.SQL.html#selectAudit"><span class="hs-identifier">selectAudit</span></a></a><span> </span><a name="local-1628432572"><a href="#local-1628432572"><span class="hs-identifier">table</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.SQL.Select.html#selectColumns"><span class="hs-identifier hs-var">selectColumns</span></a><span> </span><span class="hs-char">'makeAudit table [&quot;audit_time&quot;, &quot;audit_user&quot;, &quot;audit_ip&quot;, &quot;audit_action&quot;]

actionCmd :: AuditAction -&gt; String
actionCmd AuditActionAdd = &quot;INSERT INTO&quot;
actionCmd AuditActionChange = &quot;UPDATE&quot;
actionCmd AuditActionRemove = &quot;DELETE FROM&quot;
actionCmd a = error $ &quot;actionCmd: &quot; ++ show a

auditQuery :: AuditAction -&gt; TH.Name -- ^ @'AuditIdentity'@
  -&gt; String -&gt; String -&gt; Maybe SelectOutput -&gt; TH.ExpQ
auditQuery action ident tablef stmt =
  maybe (makePGQuery flags sql) (makeQuery flags ((sql ++) . (&quot; RETURNING &quot; ++)))
  where
  sql = &quot;WITH audit_row AS (&quot; &lt;&gt; actionCmd action &lt;&gt; &quot; &quot; &lt;&gt; table &lt;&gt; &quot; &quot; &lt;&gt; stmt
    &lt;&gt; &quot; RETURNING *) INSERT INTO audit.&quot; &lt;&gt; table
    &lt;&gt; &quot; SELECT CURRENT_TIMESTAMP, ${auditWho &quot; &lt;&gt; idents &lt;&gt; &quot;}, ${auditIp &quot; &lt;&gt; idents &lt;&gt; &quot;}, &quot; &lt;&gt; pgSafeLiteralString action &lt;&gt; &quot;, * FROM audit_row&quot;
  idents = nameRef ident
  (flags, table) = parseQueryFlags tablef

auditInsert :: TH.Name -&gt; String -&gt; [(String, String)] -&gt; Maybe SelectOutput -&gt; TH.ExpQ
auditInsert ident table args =
  auditQuery AuditActionAdd ident table
    ('(' : intercalate &quot;,&quot; (map fst args) ++ &quot;) VALUES (&quot; ++ intercalate &quot;,&quot; (map snd args) ++ &quot;)&quot;)

auditDelete :: TH.Name -&gt; String -&gt; String -&gt; Maybe SelectOutput -&gt; TH.ExpQ
auditDelete ident table wher =
  auditQuery AuditActionRemove ident table (&quot;WHERE &quot; ++ wher)

auditUpdate :: TH.Name -&gt; String -&gt; [(String, String)] -&gt; String -&gt; Maybe SelectOutput -&gt; TH.ExpQ
auditUpdate ident table sets wher =
  auditQuery AuditActionChange ident table
    (&quot;SET &quot; ++ intercalate &quot;,&quot; (map pairEq sets) ++ &quot; WHERE &quot; ++ wher)

selectAuditActivity :: String -&gt; Selector -- ^ @'Timestamp'@
selectAuditActivity table =
  selector (&quot;audit.&quot; ++ table ++ &quot; AS audit&quot;) (SelectColumn &quot;audit&quot; &quot;audit_time&quot;)

pairEq :: (String, String) -&gt; String
pairEq (c, v) = c ++ &quot;=&quot; ++ v

whereEq :: [(String, String)] -&gt; String
whereEq = intercalate &quot; AND &quot; . map pairEq
</span></pre></body></html>