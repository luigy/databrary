<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, QuasiQuotes, RecordWildCards, DataKinds #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">VolumeState</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">VolumeState</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../Databrary-Model-VolumeState.html#v:lookupVolumeState"><span class="hs-identifier hs-var">lookupVolumeState</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../Databrary-Model-VolumeState.html#v:changeVolumeState"><span class="hs-identifier hs-var">changeVolumeState</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../Databrary-Model-VolumeState.html#v:removeVolumeState"><span class="hs-identifier hs-var">removeVolumeState</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pgSQL</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Service-DB.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Service</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Permission-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Permission</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Volume-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-VolumeState-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">VolumeState</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-VolumeState-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">VolumeState</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-identifier">lookupVolumeState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628330297"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628330296"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628330296"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.VolumeState.Types.html#VolumeState"><span class="hs-identifier hs-type">VolumeState</span></a><span class="hs-special">]</span><span>
</span><a name="line-20"></a><a name="lookupVolumeState"><a href="../Databrary-Model-VolumeState.html#v:lookupVolumeState"><span class="hs-identifier">lookupVolumeState</span></a></a><span> </span><a name="local-1628330298"><a href="#local-1628330298"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-21"></a><span>  </span><a href="../Databrary-Service-DB.html#v:dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1628330298"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectVolumeState</span><span> </span><span class="hs-string">&quot;$WHERE volume = ${volumeId $ volumeRow v} AND (public OR ${volumePermission v &gt;= PermissionEDIT})&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-identifier">changeVolumeState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628330295"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628330294"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.VolumeState.Types.html#VolumeState"><span class="hs-identifier hs-type">VolumeState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628330294"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><a name="changeVolumeState"><a href="../Databrary-Model-VolumeState.html#v:changeVolumeState"><span class="hs-identifier">changeVolumeState</span></a></a><span> </span><a href="Databrary.Model.VolumeState.Types.html#VolumeState"><span class="hs-identifier hs-var">VolumeState</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="../Databrary-Model-SQL.html#v:updateOrInsert"><span class="hs-identifier hs-var">updateOrInsert</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">UPDATE</span><span> </span><span class="hs-identifier hs-var">volume_state</span><span> </span><span class="hs-identifier hs-var">SET</span><span> </span><span class="hs-identifier hs-var">value</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeStateValue</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">public</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeStatePublic</span><span class="hs-special">}</span><span> </span><span class="hs-identifier hs-var">WHERE</span><span> </span><span class="hs-identifier hs-var">volume</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeId</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">volumeRow</span><span> </span><span class="hs-identifier hs-var">stateVolume</span><span class="hs-special">}</span><span> </span><span class="hs-identifier hs-var">AND</span><span> </span><span class="hs-identifier hs-var">key</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeStateKey</span><span class="hs-special">}</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">INSERT</span><span> </span><span class="hs-identifier hs-var">INTO</span><span> </span><span class="hs-identifier hs-var">volume_state</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">volume</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">key</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">value</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">public</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">VALUES</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeId</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">volumeRow</span><span> </span><span class="hs-identifier hs-var">stateVolume</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeStateKey</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeStateValue</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeStatePublic</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-identifier">removeVolumeState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628330293"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628330292"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.VolumeState.Types.html#VolumeStateKey"><span class="hs-identifier hs-type">VolumeStateKey</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628330292"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-29"></a><a name="removeVolumeState"><a href="../Databrary-Model-VolumeState.html#v:removeVolumeState"><span class="hs-identifier">removeVolumeState</span></a></a><span> </span><a name="local-1628330332"><a href="#local-1628330332"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1628330333"><a href="#local-1628330333"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-30"></a><span>  </span><a href="../Databrary-Service-DB.html#v:dbExecute1"><span class="hs-identifier hs-var">dbExecute1</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">DELETE</span><span> </span><span class="hs-identifier hs-var">FROM</span><span> </span><span class="hs-identifier hs-var">volume_state</span><span> </span><span class="hs-identifier hs-var">WHERE</span><span> </span><span class="hs-identifier hs-var">volume</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">volumeId</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">volumeRow</span><span> </span><span class="hs-identifier hs-var">v</span><span class="hs-special">}</span><span> </span><span class="hs-identifier hs-var">AND</span><span> </span><span class="hs-identifier hs-var">key</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">k</span><span class="hs-special">}</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-31"></a></pre></body></html>