<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, QuasiQuotes, DataKinds #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Stats</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.Stats.html#lookupSiteStats"><span class="hs-identifier hs-var">lookupSiteStats</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM2</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Unboxed</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Scientific</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toBoundedInteger</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pgSQL</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Service-DB.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Service</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Stats-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Stats</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-identifier">useTDB</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-identifier">lookupSiteStats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628321628"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628321627"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-1628321627"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Databrary.Model.Stats.Types.html#SiteStats"><span class="hs-identifier hs-type">SiteStats</span></a><span>
</span><a name="line-19"></a><a name="lookupSiteStats"><a href="Databrary.Model.Stats.html#lookupSiteStats"><span class="hs-identifier">lookupSiteStats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-20"></a><span>  </span><a name="local-1628321640"><a href="#local-1628321640"><span class="hs-identifier">ac</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">SELECT</span><span> </span><span class="hs-identifier hs-var">site</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">count</span><span class="hs-special">(</span><span class="hs-identifier hs-var">child</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">FROM</span><span> </span><span class="hs-identifier hs-var">authorize_view</span><span> </span><span class="hs-identifier hs-var">WHERE</span><span> </span><span class="hs-identifier hs-var">parent</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">AND</span><span> </span><span class="hs-identifier hs-var">child</span><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-identifier hs-var">GROUP</span><span> </span><span class="hs-identifier hs-var">BY</span><span> </span><span class="hs-identifier hs-var">site</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-21"></a><span>  </span><a name="local-1628321646"><a href="#local-1628321646"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Service.DB.html#dbQuery1%27"><span class="hs-identifier hs-var">dbQuery1'</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">SELECT</span><span> </span><span class="hs-identifier hs-var">count</span><span class="hs-special">(</span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">FROM</span><span> </span><span class="hs-identifier hs-var">volume</span><span> </span><span class="hs-identifier hs-var">WHERE</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-22"></a><span>  </span><a name="local-1628321652"><a href="#local-1628321652"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Service.DB.html#dbQuery1%27"><span class="hs-identifier hs-var">dbQuery1'</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">SELECT</span><span> </span><span class="hs-identifier hs-var">count</span><span class="hs-special">(</span><span class="hs-identifier hs-var">volume</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">FROM</span><span> </span><span class="hs-identifier hs-var">volume_access</span><span> </span><span class="hs-identifier hs-var">WHERE</span><span> </span><span class="hs-identifier hs-var">volume</span><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">AND</span><span> </span><span class="hs-identifier hs-var">party</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">AND</span><span> </span><span class="hs-identifier hs-var">children</span><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-char">'PUBLIC'|]
  (a, ad, ab) &lt;- dbQuery1' [pgSQL|SELECT count(id), sum(duration), sum(size) FROM asset JOIN slot_asset ON asset = id WHERE volume &gt; 0|]
  rc &lt;- dbQuery [pgSQL|SELECT category, count(id) FROM record GROUP BY category ORDER BY category|]
  return SiteStats
    { statsAuthorizedSite = A.accumArray (+) 0 (minBound, maxBound) $ l ac
    , statsVolumes = z v
    , statsVolumesShared = z vs
    , statsAssets = z a
    , statsAssetDuration = z ad
    , statsAssetBytes = z $ toBoundedInteger =&lt;&lt; ab
    , statsRecords = M.fromDistinctAscList $ l rc
    }
  where
  z :: Num a =&gt; Maybe a -&gt; a
  z = fromMaybe 0
  l :: [(Maybe a, Maybe b)] -&gt; [(a, b)]
  l = mapMaybe (uncurry $ liftM2 (,))
</span></pre></body></html>