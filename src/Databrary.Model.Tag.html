<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, QuasiQuotes, RecordWildCards, OverloadedStrings, DataKinds #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Tag</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Tag</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#lookupTag"><span class="hs-identifier hs-var">lookupTag</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#lookupTags"><span class="hs-identifier hs-var">lookupTags</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#findTags"><span class="hs-identifier hs-var">findTags</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#addTag"><span class="hs-identifier hs-var">addTag</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#lookupVolumeTagUseRows"><span class="hs-identifier hs-var">lookupVolumeTagUseRows</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#addTagUse"><span class="hs-identifier hs-var">addTagUse</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#removeTagUse"><span class="hs-identifier hs-var">removeTagUse</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#lookupTopTagWeight"><span class="hs-identifier hs-var">lookupTopTagWeight</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#lookupTagCoverage"><span class="hs-identifier hs-var">lookupTagCoverage</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#lookupSlotTagCoverage"><span class="hs-identifier hs-var">lookupSlotTagCoverage</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#lookupSlotKeywords"><span class="hs-identifier hs-var">lookupSlotKeywords</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#tagWeightJSON"><span class="hs-identifier hs-var">tagWeightJSON</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.html#tagCoverageJSON"><span class="hs-identifier hs-var">tagCoverageJSON</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">guard</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSC</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int64</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pgSQL</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Ops.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Ops</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Has.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Has</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Has.html#peek"><span class="hs-identifier hs-var">peek</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Databrary.JSON.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">JSON</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">JSON</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Service.DB.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Service</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Party.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Party</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Identity.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Identity</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Volume.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Container.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Slot.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Slot</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Tag.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Tag</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Tag.SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Tag</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-identifier">lookupTag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628384536"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628384535"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Tag.Types.html#TagName"><span class="hs-identifier hs-type">TagName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628384535"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.Tag.Types.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><a name="lookupTag"><a href="Databrary.Model.Tag.html#lookupTag"><span class="hs-identifier">lookupTag</span></a></a><span> </span><a name="local-1628384537"><a href="#local-1628384537"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-41"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery1"><span class="hs-identifier hs-var">dbQuery1</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectTag</span><span> </span><span class="hs-string">&quot;$WHERE tag.name = ${n}::varchar&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-identifier">lookupTags</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628384534"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628384533"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-1628384533"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Tag.Types.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span>
</span><a name="line-44"></a><a name="lookupTags"><a href="Databrary.Model.Tag.html#lookupTags"><span class="hs-identifier">lookupTags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectTag</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-identifier">findTags</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628384532"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628384531"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Tag.Types.html#TagName"><span class="hs-identifier hs-type">TagName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628384531"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Tag.Types.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span>
</span><a name="line-47"></a><a name="findTags"><a href="Databrary.Model.Tag.html#findTags"><span class="hs-identifier">findTags</span></a></a><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Tag.Types.html#TagName"><span class="hs-identifier hs-var">TagName</span></a><span> </span><a name="local-1628384556"><a href="#local-1628384556"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628384557"><a href="#local-1628384557"><span class="hs-identifier">lim</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- TagName restrictions obviate pattern escaping</span><span>
</span><a name="line-48"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectTag</span><span> </span><span class="hs-string">&quot;$WHERE tag.name LIKE ${n `BSC.snoc` '%'}::varchar LIMIT ${fromIntegral lim :: Int64}&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-identifier">addTag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628384530"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628384529"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Tag.Types.html#TagName"><span class="hs-identifier hs-type">TagName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628384529"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Databrary.Model.Tag.Types.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>
</span><a name="line-51"></a><a name="addTag"><a href="Databrary.Model.Tag.html#addTag"><span class="hs-identifier">addTag</span></a></a><span> </span><a name="local-1628384569"><a href="#local-1628384569"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-52"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery1%27"><span class="hs-identifier hs-var">dbQuery1'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Databrary.Model.Tag.Types.html#Tag"><span class="hs-identifier hs-var">Tag</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628384569"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-operator">|!</span><span class="hs-identifier hs-var">SELECT</span><span> </span><span class="hs-identifier hs-var">get_tag</span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">n</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-identifier">lookupVolumeTagUseRows</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628384528"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628384527"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628384527"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Tag.Types.html#TagUseRow"><span class="hs-identifier hs-type">TagUseRow</span></a><span class="hs-special">]</span><span>
</span><a name="line-55"></a><a name="lookupVolumeTagUseRows"><a href="Databrary.Model.Tag.html#lookupVolumeTagUseRows"><span class="hs-identifier">lookupVolumeTagUseRows</span></a></a><span> </span><a name="local-1628384576"><a href="#local-1628384576"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-56"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectTagUseRow</span><span> </span><span class="hs-string">&quot;JOIN container ON tag_use.container = container.id WHERE container.volume = ${volumeId $ volumeRow v} ORDER BY container.id&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-identifier">addTagUse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1628384526"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1628384525"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Tag.Types.html#TagUse"><span class="hs-identifier hs-type">TagUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628384525"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-59"></a><a name="addTagUse"><a href="Databrary.Model.Tag.html#addTagUse"><span class="hs-identifier">addTagUse</span></a></a><span> </span><a name="local-1628384595"><a href="#local-1628384595"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-60"></a><span>  </span><a href="Databrary.Service.DB.html#dbTryJust"><span class="hs-identifier hs-var">dbTryJust</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.SQL.html#isExclusionViolation"><span class="hs-identifier hs-var">isExclusionViolation</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Service.DB.html#dbExecute1"><span class="hs-identifier hs-var">dbExecute1</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="Databrary.Model.Tag.Types.html#tagKeyword"><span class="hs-identifier hs-var">tagKeyword</span></a><span> </span><a href="#local-1628384595"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-62"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">insertTagUse</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-char">'t)
      else $(insertTagUse False 't))

removeTagUse :: MonadDB c m =&gt; TagUse -&gt; m Int
removeTagUse t =
  dbExecute
    (if tagKeyword t
      then $(deleteTagUse True 't)
      else $(deleteTagUse False 't))

lookupTopTagWeight :: MonadDB c m =&gt; Int -&gt; m [TagWeight]
lookupTopTagWeight lim =
  dbQuery $(selectQuery (selectTagWeight &quot;&quot;) &quot;$!ORDER BY weight DESC LIMIT ${fromIntegral lim :: Int64}&quot;)

emptyTagCoverage :: Tag -&gt; Container -&gt; TagCoverage
emptyTagCoverage t c = TagCoverage (TagWeight t 0) c [] [] []

lookupTagCoverage :: (MonadDB c m, MonadHasIdentity c m) =&gt; Tag -&gt; Slot -&gt; m TagCoverage
lookupTagCoverage t (Slot c s) = do
  ident &lt;- peek
  fromMaybe (emptyTagCoverage t c) &lt;$&gt; dbQuery1 (($ c) . ($ t) &lt;$&gt; $(selectQuery (selectTagCoverage 'ident &quot;WHERE container = ${containerId $ containerRow c} AND segment &amp;&amp; ${s} AND tag = ${tagId t}&quot;) &quot;$!&quot;))

lookupSlotTagCoverage :: (MonadDB c m, MonadHasIdentity c m) =&gt; Slot -&gt; Int -&gt; m [TagCoverage]
lookupSlotTagCoverage slot lim = do
  ident &lt;- peek
  dbQuery $(selectQuery (selectSlotTagCoverage 'ident 'slot) &quot;$!ORDER BY weight DESC LIMIT ${fromIntegral lim :: Int64}&quot;)

lookupSlotKeywords :: (MonadDB c m) =&gt; Slot -&gt; m [Tag]
lookupSlotKeywords Slot{..} =
  dbQuery $(selectQuery selectTag &quot;JOIN keyword_use ON id = tag WHERE container = ${containerId $ containerRow slotContainer} AND segment = ${slotSegment}&quot;)

tagWeightJSON :: JSON.ToObject o =&gt; TagWeight -&gt; JSON.Record TagName o
tagWeightJSON TagWeight{..} = JSON.Record (tagName tagWeightTag) $
  &quot;weight&quot; JSON..= tagWeightWeight

tagCoverageJSON :: JSON.ToObject o =&gt; TagCoverage -&gt; JSON.Record TagName o
tagCoverageJSON TagCoverage{..} = tagWeightJSON tagCoverageWeight JSON..&lt;&gt;
     &quot;coverage&quot; JSON..= tagCoverageSegments
  &lt;&gt; &quot;keyword&quot; JSON..=? (tagCoverageKeywords &lt;!? null tagCoverageKeywords)
  &lt;&gt; &quot;vote&quot;    JSON..=? (tagCoverageVotes    &lt;!? null tagCoverageVotes)
</span></pre></body></html>