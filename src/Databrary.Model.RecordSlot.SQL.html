<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, OverloadedStrings #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">RecordSlot</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectRecordContainerSlotRecord"><span class="hs-identifier hs-var">selectRecordContainerSlotRecord</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectContainerSlotRecord"><span class="hs-identifier hs-var">selectContainerSlotRecord</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectRecordSlotRecord"><span class="hs-identifier hs-var">selectRecordSlotRecord</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectVolumeSlotRecord"><span class="hs-identifier hs-var">selectVolumeSlotRecord</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectVolumeSlotIdRecord"><span class="hs-identifier hs-var">selectVolumeSlotIdRecord</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectVolumeSlotMaybeRecord"><span class="hs-identifier hs-var">selectVolumeSlotMaybeRecord</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectVolumeSlotMaybeRecordId"><span class="hs-identifier hs-var">selectVolumeSlotMaybeRecordId</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#selectSlotRecord"><span class="hs-identifier hs-var">selectSlotRecord</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#insertSlotRecord"><span class="hs-identifier hs-var">insertSlotRecord</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#updateSlotRecord"><span class="hs-identifier hs-var">updateSlotRecord</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.RecordSlot.SQL.html#deleteSlotRecord"><span class="hs-identifier hs-var">deleteSlotRecord</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Has.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Has</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Has.html#view"><span class="hs-identifier hs-var">view</span></a><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Id-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Id</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Segment.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Segment</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Volume-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Record-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Record</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Record-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Record</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Container-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Container-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Slot-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Slot</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-SQL-Select.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span class="hs-operator">.</span><span class="hs-identifier">Select</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Audit-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Audit</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Volume-SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-RecordSlot-Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">RecordSlot</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-identifier">slotRecordRow</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.SQL.Select.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span> </span><span class="hs-comment">-- ^ @'Segment'@</span><span>
</span><a name="line-33"></a><a name="slotRecordRow"><a href="Databrary.Model.RecordSlot.SQL.html#slotRecordRow"><span class="hs-identifier">slotRecordRow</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.SQL.Select.html#selectColumn"><span class="hs-identifier hs-var">selectColumn</span></a><span> </span><span class="hs-string">&quot;slot_record&quot;</span><span> </span><span class="hs-string">&quot;segment&quot;</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-identifier">makeSlotRecord</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Segment.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Record.Types.html#Record"><span class="hs-identifier hs-type">Record</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Container.Types.html#Container"><span class="hs-identifier hs-type">Container</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.RecordSlot.Types.html#RecordSlot"><span class="hs-identifier hs-type">RecordSlot</span></a><span>
</span><a name="line-36"></a><a name="makeSlotRecord"><a href="Databrary.Model.RecordSlot.SQL.html#makeSlotRecord"><span class="hs-identifier">makeSlotRecord</span></a></a><span> </span><a name="local-1628705530"><a href="#local-1628705530"><span class="hs-identifier">seg</span></a></a><span> </span><a name="local-1628705531"><a href="#local-1628705531"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-1628705532"><a href="#local-1628705532"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.RecordSlot.Types.html#RecordSlot"><span class="hs-identifier hs-var">RecordSlot</span></a><span> </span><a href="#local-1628705531"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Slot.Types.html#Slot"><span class="hs-identifier hs-var">Slot</span></a><span> </span><a href="#local-1628705532"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-1628705530"><span class="hs-identifier hs-var">seg</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-identifier">selectRecordContainerSlotRecord</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.SQL.Select.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span> </span><span class="hs-comment">-- ^ @'Record' -&gt; 'Container' -&gt; 'RecordSlot'@</span><span>
</span><a name="line-39"></a><a name="selectRecordContainerSlotRecord"><a href="Databrary.Model.RecordSlot.SQL.html#selectRecordContainerSlotRecord"><span class="hs-identifier">selectRecordContainerSlotRecord</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.SQL.Select.html#selectMap"><span class="hs-identifier hs-var">selectMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">VarE</span><span> </span><span class="hs-char">'makeSlotRecord `TH.AppE`) slotRecordRow

makeContainerSlotRecord :: (Record -&gt; Container -&gt; RecordSlot) -&gt; (Volume -&gt; Record) -&gt; Container -&gt; RecordSlot
makeContainerSlotRecord f rf c = f (rf (view c)) c

selectContainerSlotRecord :: Selector -- ^ @'Container' -&gt; 'RecordSlot'@
selectContainerSlotRecord = selectJoin 'makeContainerSlotRecord
  [ selectRecordContainerSlotRecord
  , joinOn &quot;slot_record.record = record.id&quot;
    selectVolumeRecord -- XXX volumes match?
  ]

makeRecordSlotRecord :: (Record -&gt; Container -&gt; RecordSlot) -&gt; (Volume -&gt; Container) -&gt; Record -&gt; RecordSlot
makeRecordSlotRecord f cf r = f r (cf (view r))

selectRecordSlotRecord :: Selector -- ^ @'Record' -&gt; 'RecordSlot'@
selectRecordSlotRecord = selectJoin 'makeRecordSlotRecord
  [ selectRecordContainerSlotRecord
  , joinOn &quot;slot_record.container = container.id&quot;
    selectVolumeContainer -- XXX volumes match?
  ]

makeVolumeSlotRecord :: (Record -&gt; Container -&gt; RecordSlot) -&gt; (Volume -&gt; Record) -&gt; (Volume -&gt; Container) -&gt; Volume -&gt; RecordSlot
makeVolumeSlotRecord f rf cf v = f (rf v) (cf v)

selectVolumeSlotRecord :: Selector -- ^ @'Volume' -&gt; 'RecordSlot'@
selectVolumeSlotRecord = selectJoin 'makeVolumeSlotRecord
  [ selectRecordContainerSlotRecord
  , joinOn &quot;slot_record.record = record.id&quot;
    selectVolumeRecord
  , joinOn &quot;slot_record.container = container.id AND record.volume = container.volume&quot;
    selectVolumeContainer
  ]

makeVolumeSlotIdRecord :: SlotId -&gt; (Volume -&gt; Record) -&gt; Volume -&gt; (Record, SlotId)
makeVolumeSlotIdRecord s rf v = (rf v, s)

selectVolumeSlotIdRecord :: Selector -- ^ @'Volume' -&gt; ('Record', 'SlotId')@
selectVolumeSlotIdRecord = selectJoin 'makeVolumeSlotIdRecord
  [ selectColumns 'SlotId &quot;slot_record&quot; [&quot;container&quot;, &quot;segment&quot;]
  , joinOn &quot;slot_record.record = record.id&quot;
    selectVolumeRecord --- XXX volumes match?
  ]

makeVolumeSlotMaybeRecord :: (Volume -&gt; Container) -&gt; Maybe (Container -&gt; RecordSlot) -&gt; Volume -&gt; (Container, Maybe RecordSlot)
makeVolumeSlotMaybeRecord cf Nothing v = (cf v, Nothing)
makeVolumeSlotMaybeRecord cf (Just rf) v = (c, Just (rf c)) where c = cf v

selectVolumeSlotMaybeRecord :: Selector -- ^ @'Volume' -&gt; ('Container, Maybe 'RecordSlot)@
selectVolumeSlotMaybeRecord = selectJoin 'makeVolumeSlotMaybeRecord
  [ selectVolumeContainer
  , maybeJoinOn &quot;container.id = slot_record.container AND container.volume = record.volume&quot;
    selectContainerSlotRecord
  ]

segmentRecordIdTuple :: Segment -&gt; Id Record -&gt; (Segment, Id Record)
segmentRecordIdTuple = (,)

makeVolumeContainerTuple :: (Volume -&gt; Container) -&gt; a -&gt; Volume -&gt; (Container, a)
makeVolumeContainerTuple cf a v = (cf v, a)

selectVolumeSlotMaybeRecordId :: Selector -- ^ @'Volume' -&gt; ('Container', Maybe ('Segment', 'Id' 'Record'))@
selectVolumeSlotMaybeRecordId = selectJoin 'makeVolumeContainerTuple
  [ selectVolumeContainer
  , maybeJoinOn &quot;container.id = slot_record.container&quot;
    $ selectColumns 'segmentRecordIdTuple &quot;slot_record&quot; [&quot;segment&quot;, &quot;record&quot;]
  ]

selectSlotRecord :: TH.Name -- ^ @'Identity'@
  -&gt; Selector -- ^ @'RecordSlot'@
selectSlotRecord ident = selectJoin '($)
  [ selectVolumeSlotRecord
  , joinOn &quot;record.volume = volume.id&quot;
    $ selectVolume ident
  ]

slotRecordVals :: String -- ^ @'RecordSlot'@
  -&gt; [(String, String)]
slotRecordVals o =
  [ (&quot;record&quot;, &quot;${recordId $ recordRow $ slotRecord &quot; ++ o ++ &quot;}&quot;)
  , (&quot;container&quot;, &quot;${containerId $ containerRow $ slotContainer $ recordSlot &quot; ++ o ++ &quot;}&quot;)
  , (&quot;segment&quot;, &quot;${slotSegment $ recordSlot &quot; ++ o ++ &quot;}&quot;)
  ]

insertSlotRecord :: TH.Name -- ^ @'AuditIdentity'@
  -&gt; TH.Name -- ^ @'RecordSlot'@
  -&gt; TH.ExpQ
insertSlotRecord ident o = auditInsert ident &quot;slot_record&quot;
  (slotRecordVals os)
  Nothing
  where os = nameRef o

updateSlotRecord :: TH.Name -- ^ @'AuditIdentity'@
  -&gt; TH.Name -- ^ @'RecordSlot'@
  -&gt; TH.Name -- ^ @'Segment'@
  -&gt; TH.ExpQ
updateSlotRecord ident o ds = auditUpdate ident &quot;slot_record&quot;
  [ (&quot;segment&quot;, &quot;${&quot; ++ nameRef ds ++ &quot;}&quot;) ]
  (whereEq $ slotRecordVals $ nameRef o)
  Nothing

deleteSlotRecord :: TH.Name -- ^ @'AuditIdentity'@
  -&gt; TH.Name -- ^ @'RecordSlot'@
  -&gt; TH.ExpQ
deleteSlotRecord ident o = auditDelete ident &quot;slot_record&quot;
  (&quot;record = ${recordId $ recordRow $ slotRecord &quot; ++ os ++ &quot;} AND container = ${containerId $ containerRow $ slotContainer $ recordSlot &quot; ++ os ++ &quot;} AND segment &lt;@ ${slotSegment $ recordSlot &quot; ++ os ++ &quot;}&quot;)
  Nothing
  where os = nameRef o
</span></pre></body></html>