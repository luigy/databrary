<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, TemplateHaskell, RecordWildCards, DataKinds #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Activity</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.Activity.html#lookupPartyActivity"><span class="hs-identifier hs-var">lookupPartyActivity</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Activity.html#lookupVolumeActivity"><span class="hs-identifier hs-var">lookupVolumeActivity</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Activity.html#lookupContainerActivity"><span class="hs-identifier hs-var">lookupContainerActivity</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Activity.html#activityJSON"><span class="hs-identifier hs-var">activityJSON</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;|&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Arrow</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;&amp;&amp;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forM</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSC</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Function</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">on</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">diffUTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Ops.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Ops</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Has.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Has</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Databrary.JSON.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">JSON</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">JSON</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Service.DB.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Service</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Identity.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Identity</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Id.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Id</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Time.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Audit.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Audit</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Volume.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.VolumeAccess.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">VolumeAccess</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Party.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Party</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Authorize.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Authorize</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Container.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Segment.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Segment</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Slot.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Slot</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Asset.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Asset</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.AssetRevision.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">AssetRevision</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Activity.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Activity</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Activity.SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Activity</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-identifier">onActivityTime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Time.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Time.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629381600"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629381600"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-43"></a><a name="onActivityTime"><a href="Databrary.Model.Activity.html#onActivityTime"><span class="hs-identifier">onActivityTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><a href="Databrary.Model.Audit.Types.html#auditWhen"><span class="hs-identifier hs-var">auditWhen</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityAudit"><span class="hs-identifier hs-var">activityAudit</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-identifier">orderActivity</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-46"></a><a name="orderActivity"><a href="Databrary.Model.Activity.html#orderActivity"><span class="hs-identifier">orderActivity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.Activity.html#onActivityTime"><span class="hs-identifier hs-var">onActivityTime</span></a><span> </span><span class="hs-identifier hs-var">compare</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-identifier">mergeActivity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span>
</span><a name="line-49"></a><a name="mergeActivity"><a href="Databrary.Model.Activity.html#mergeActivity"><span class="hs-identifier">mergeActivity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Ops.html#mergeBy"><span class="hs-identifier hs-var">mergeBy</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1629381601"><a href="#local-1629381601"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1629381602"><a href="#local-1629381602"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.Model.Activity.html#orderActivity"><span class="hs-identifier hs-var">orderActivity</span></a><span> </span><a href="#local-1629381601"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-1629381602"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">mergeActivities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span>
</span><a name="line-52"></a><a name="mergeActivities"><a href="Databrary.Model.Activity.html#mergeActivities"><span class="hs-identifier">mergeActivities</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><a href="Databrary.Model.Activity.html#mergeActivity"><span class="hs-identifier hs-var">mergeActivity</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-identifier">joinActivitiesWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span>
</span><a name="line-55"></a><a name="joinActivitiesWith"><a href="Databrary.Model.Activity.html#joinActivitiesWith"><span class="hs-identifier">joinActivitiesWith</span></a></a><span> </span><a name="local-1629381603"><a href="#local-1629381603"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1629381604"><a href="#local-1629381604"><span class="hs-identifier">a1</span></a></a><span class="hs-glyph">:</span><a name="local-1629381605"><a href="#local-1629381605"><span class="hs-identifier">a1r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-1629381606"><span class="hs-identifier hs-var">al</span></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1629381607"><a href="#local-1629381607"><span class="hs-identifier">af</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1629381608"><a href="#local-1629381608"><span class="hs-identifier">la</span></a></a><span> </span><a name="local-1629381609"><a href="#local-1629381609"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1629381610"><a href="#local-1629381610"><span class="hs-identifier">a2</span></a></a><span class="hs-glyph">:</span><a name="local-1629381611"><a href="#local-1629381611"><span class="hs-identifier">a2r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="Databrary.Model.Activity.html#onActivityTime"><span class="hs-identifier hs-var">onActivityTime</span></a><span> </span><span class="hs-identifier hs-var">diffUTCTime</span><span> </span><a href="#local-1629381610"><span class="hs-identifier hs-var">a2</span></a><span> </span><a href="#local-1629381604"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381606"><span class="hs-identifier hs-var">al</span></a><span>
</span><a name="line-59"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><a href="Databrary.Model.Audit.Types.html#auditIdentity"><span class="hs-identifier hs-var">auditIdentity</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityAudit"><span class="hs-identifier hs-var">activityAudit</span></a><span class="hs-special">)</span><span> </span><a href="#local-1629381604"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-1629381610"><span class="hs-identifier hs-var">a2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1629381612"><a href="#local-1629381612"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1629381607"><span class="hs-identifier hs-var">af</span></a><span> </span><a href="#local-1629381610"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381612"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Databrary.Model.Activity.html#joinActivitiesWith"><span class="hs-identifier hs-var">joinActivitiesWith</span></a><span> </span><a href="#local-1629381603"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-1629381609"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-1629381611"><span class="hs-identifier hs-var">a2r</span></a><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381608"><span class="hs-identifier hs-var">la</span></a><span> </span><span class="hs-special">(</span><a href="#local-1629381609"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="#local-1629381610"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1629381611"><span class="hs-identifier hs-var">a2r</span></a><span>
</span><a name="line-61"></a><span>        </span><span class="hs-identifier">la</span><span> </span><a name="local-1629381613"><a href="#local-1629381613"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381604"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Databrary.Model.Activity.html#joinActivitiesWith"><span class="hs-identifier hs-var">joinActivitiesWith</span></a><span> </span><a href="#local-1629381603"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-1629381613"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="#local-1629381608"><span class="hs-identifier hs-var">la</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="#local-1629381605"><span class="hs-identifier hs-var">a1r</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1629381603"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1629381604"><span class="hs-identifier hs-var">a1</span></a><span>
</span><a name="line-64"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1629381606"><a href="#local-1629381606"><span class="hs-identifier">al</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381604"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Databrary.Model.Activity.html#joinActivitiesWith"><span class="hs-identifier hs-var">joinActivitiesWith</span></a><span> </span><a href="#local-1629381603"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1629381605"><span class="hs-identifier hs-var">a1r</span></a><span>
</span><a name="line-65"></a><span class="hs-identifier">joinActivitiesWith</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-identifier">chainPrev</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-1629381599"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Activity.Types.html#ActivityTarget"><span class="hs-identifier hs-type">ActivityTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629381599"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span>
</span><a name="line-68"></a><a name="chainPrev"><a href="Databrary.Model.Activity.html#chainPrev"><span class="hs-identifier">chainPrev</span></a></a><span> </span><a name="local-1629381614"><a href="#local-1629381614"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381615"><span class="hs-identifier hs-var">scan</span></a><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-69"></a><span>  </span><a name="local-1629381615"><a href="#local-1629381615"><span class="hs-identifier">scan</span></a></a><span> </span><a name="local-1629381616"><a href="#local-1629381616"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1629381617"><a href="#local-1629381617"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-var">Activity</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityAudit"><span class="hs-identifier hs-var">activityAudit</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.Audit.Types.html#Audit"><span class="hs-identifier hs-var">Audit</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Audit.Types.html#auditAction"><span class="hs-identifier hs-var">auditAction</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1629381618"><a href="#local-1629381618"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityTarget"><span class="hs-identifier hs-var">activityTarget</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1629381619"><a href="#local-1629381619"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-glyph">:</span><a name="local-1629381620"><a href="#local-1629381620"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381617"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityPrev"><span class="hs-identifier hs-var">activityPrev</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381621"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1629381615"><span class="hs-identifier hs-var">scan</span></a><span> </span><a href="#local-1629381622"><span class="hs-identifier hs-var">m'</span></a><span> </span><a href="#local-1629381620"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-special">(</span><a name="local-1629381621"><a href="#local-1629381621"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1629381622"><a href="#local-1629381622"><span class="hs-identifier">m'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1629381618"><span class="hs-identifier hs-var">act</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-71"></a><span>      </span><a href="Databrary.Model.Audit.Types.html#AuditActionAdd"><span class="hs-identifier hs-var">AuditActionAdd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><span class="hs-special">(</span><a href="#local-1629381614"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1629381619"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-1629381619"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1629381616"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>      </span><a href="Databrary.Model.Audit.Types.html#AuditActionRemove"><span class="hs-identifier hs-var">AuditActionRemove</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">updateLookupWithKey</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1629381614"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1629381619"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-1629381616"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-73"></a><span>      </span><a href="Databrary.Model.Audit.Types.html#AuditActionChange"><span class="hs-identifier hs-var">AuditActionChange</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insertLookupWithKey</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">const</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1629381614"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1629381619"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-1629381619"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1629381616"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-74"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Activity.Types.html#activityPrev"><span class="hs-identifier hs-var">activityPrev</span></a><span> </span><a href="#local-1629381617"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1629381616"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-identifier">scan</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-identifier">maskPasswords</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span>
</span><a name="line-78"></a><a name="maskPasswords"><a href="Databrary.Model.Activity.html#maskPasswords"><span class="hs-identifier">maskPasswords</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381623"><span class="hs-identifier hs-var">mp</span></a><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-comment">-- this could be done much more simply since passwords are never going to repeat in practice</span><span>
</span><a name="line-80"></a><span>  </span><a name="local-1629381623"><a href="#local-1629381623"><span class="hs-identifier">mp</span></a></a><span> </span><a name="local-1629381624"><a href="#local-1629381624"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-1629381625"><a href="#local-1629381625"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1629381626"><a href="#local-1629381626"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-var">Activity</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityTarget"><span class="hs-identifier hs-var">activityTarget</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1629381627"><a href="#local-1629381627"><span class="hs-identifier">at</span></a></a><span class="hs-glyph">@</span><a href="Databrary.Model.Activity.Types.html#ActivityAccount"><span class="hs-identifier hs-var">ActivityAccount</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityAccountPassword"><span class="hs-identifier hs-var">activityAccountPassword</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1629381628"><a href="#local-1629381628"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-glyph">:</span><a name="local-1629381629"><a href="#local-1629381629"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1629381632"><a href="#local-1629381632"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-1629381628"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1629381624"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381630"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1629381632"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1629381623"><span class="hs-identifier hs-var">mp</span></a><span> </span><a href="#local-1629381624"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-1629381625"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-1629381629"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381630"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1629381625"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1629381623"><span class="hs-identifier hs-var">mp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-1629381628"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1629381625"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-1629381624"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">succ</span><span> </span><a href="#local-1629381625"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><a href="#local-1629381629"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-83"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-1629381630"><a href="#local-1629381630"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1629381631"><a href="#local-1629381631"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381626"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityTarget"><span class="hs-identifier hs-var">activityTarget</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381627"><span class="hs-identifier hs-var">at</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityAccountPassword"><span class="hs-identifier hs-var">activityAccountPassword</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BSC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1629381631"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-identifier">mp</span><span> </span><a name="local-1629381633"><a href="#local-1629381633"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-1629381634"><a href="#local-1629381634"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1629381635"><a href="#local-1629381635"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">:</span><a name="local-1629381636"><a href="#local-1629381636"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629381635"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1629381623"><span class="hs-identifier hs-var">mp</span></a><span> </span><a href="#local-1629381633"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-1629381634"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-1629381636"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-85"></a><span>  </span><span class="hs-identifier">mp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-identifier">lookupPartyActivity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629381598"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629381597"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Identity.Types.html#MonadHasIdentity"><span class="hs-identifier hs-type">MonadHasIdentity</span></a><span> </span><a href="#local-1629381598"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629381597"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Party.Types.html#Party"><span class="hs-identifier hs-type">Party</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629381597"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.Activity.Types.html#Activity"><span class="hs-identifier hs-type">Activity</span></a><span class="hs-special">]</span><span>
</span><a name="line-88"></a><a name="lookupPartyActivity"><a href="Databrary.Model.Activity.html#lookupPartyActivity"><span class="hs-identifier">lookupPartyActivity</span></a></a><span> </span><a name="local-1629381637"><a href="#local-1629381637"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-89"></a><span>  </span><a name="local-1629381638"><a href="#local-1629381638"><span class="hs-identifier">ident</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Has.html#peek"><span class="hs-identifier hs-var">peek</span></a><span>
</span><a name="line-90"></a><span>  </span><a name="local-1629381676"><a href="#local-1629381676"><span class="hs-identifier">pa</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Activity.html#chainPrev"><span class="hs-identifier hs-var">chainPrev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectActivityParty</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;WHERE party.id = ${partyId $ partyRow p} AND &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">activityQual</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>  </span><a name="local-1629381700"><a href="#local-1629381700"><span class="hs-identifier">ca</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Activity.html#chainPrev"><span class="hs-identifier hs-var">chainPrev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Activity.html#maskPasswords"><span class="hs-identifier hs-var">maskPasswords</span></a><span>
</span><a name="line-93"></a><span>    </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectActivityAccount</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;WHERE account.id = ${partyId $ partyRow p} ORDER BY audit_time&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- unqual: include logins</span><span>
</span><a name="line-94"></a><span>  </span><a name="local-1629381754"><a href="#local-1629381754"><span class="hs-identifier">aa</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Activity.html#chainPrev"><span class="hs-identifier hs-var">chainPrev</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Party.Types.html#partyId"><span class="hs-identifier hs-var">partyId</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Party.Types.html#partyRow"><span class="hs-identifier hs-var">partyRow</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Authorize.Types.html#authorizeChild"><span class="hs-identifier hs-var">authorizeChild</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Authorize.Types.html#authorization"><span class="hs-identifier hs-var">authorization</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Activity.Types.html#activityAuthorize"><span class="hs-identifier hs-var">activityAuthorize</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectActivityAuthorize</span><span> </span><span class="hs-char">'p 'ident) $ &quot;WHERE &quot; ++ activityQual)
  return $ mergeActivities [pa, ca, aa]

lookupVolumeActivity :: (MonadDB c m, MonadHasIdentity c m) =&gt; Volume -&gt; m [Activity]
lookupVolumeActivity vol = do
  ident &lt;- peek
  va &lt;- chainPrev (const ())
    &lt;$&gt; dbQuery $(selectQuery selectActivityVolume $ &quot;!WHERE volume.id = ${volumeId $ volumeRow vol} AND &quot; ++ activityQual)
  aa &lt;- chainPrev (partyId . partyRow . volumeAccessParty . activityAccess)
    &lt;$&gt; dbQuery $(selectQuery (selectActivityAccess 'vol 'ident) $ &quot;WHERE &quot; ++ activityQual)
  return $ mergeActivities [va, aa]

addAssetRevision :: (MonadDB c m, MonadHasIdentity c m) =&gt; Volume -&gt; Activity -&gt; m Activity
addAssetRevision vol
  act@Activity{ activityAudit = Audit{ auditAction = aa }, activityTarget = ActivityAssetSlot{ activityAssetId = ai }, activityPrev = Nothing }
  | aa &lt;= AuditActionChange = do
    ar &lt;- if aa == AuditActionChange then lookupAssetReplace a else return Nothing
    at &lt;- lookupAssetTranscode a
    return act
      { activityReplace = revisionOrig &lt;$&gt; ar
      , activityTranscode = revisionOrig &lt;$&gt; at
      }
    where
    a = ba{ assetRow = (assetRow ba){ assetId = ai } }
    ba = blankAsset vol
addAssetRevision _ a = return a

mergeAssetCreation :: [Activity] -&gt; [Activity]
mergeAssetCreation = joinActivitiesWith f1 where
  f1 a@Activity{ activityAudit = Audit{ auditAction = AuditActionAdd  }, activityTarget = ActivityAsset aa, activityPrev = Nothing } = Just f2 where
    f2 Activity{ activityAudit = Audit{ auditAction = AuditActionChange }, activityTarget = ActivityAsset ac, activityPrev = Just (ActivityAsset aa') }
      | assetId aa == assetId aa' = Just a{ activityTarget = ActivityAsset ac, activityPrev = Just (ActivityAsset aa) }
    f2 _ = Nothing
  f1 _ = Nothing

mergeActivityAssetAndSlot :: ActivityTarget -&gt; ActivityTarget -&gt; Maybe ActivityTarget
mergeActivityAssetAndSlot (ActivityAsset ar) (ActivityAssetSlot ai si) =
  assetId ar == ai ?&gt; ActivityAssetAndSlot ar si
mergeActivityAssetAndSlot _ _ = Nothing

mergeAssetAndSlot :: [Activity] -&gt; [Activity]
mergeAssetAndSlot = joinActivitiesWith f1 where
  f1 Activity{ activityAudit = a1, activityTarget = t1, activityPrev = p1, activityReplace = Nothing, activityTranscode = Nothing } = Just f2 where
    f2 a@Activity{ activityAudit = a2, activityTarget = t2, activityPrev = p2 }
      | auditAction a1 &lt;= auditAction a2 &amp;&amp; auditAction a2 &lt;= AuditActionChange
      , Just t &lt;- mergeActivityAssetAndSlot t1 t2 = Just a
        { activityAudit = a1
        , activityTarget = t
        , activityPrev = (do
          p1t &lt;- p1
          mergeActivityAssetAndSlot p1t =&lt;&lt; p2) &lt;|&gt; p1 &lt;|&gt; p2
        }
    f2 _ = Nothing
  f1 _ = Nothing

lookupContainerActivity :: (MonadDB c m, MonadHasIdentity c m) =&gt; Container -&gt; m [Activity]
lookupContainerActivity cont = do
  ca &lt;- chainPrev (const ())
    &lt;$&gt; dbQuery $(selectQuery selectActivityContainer $ &quot;WHERE container.id = ${containerId $ containerRow cont} AND &quot; ++ activityQual)
  ra &lt;- chainPrev (slotSegmentId . activitySlotId)
    &lt;$&gt; dbQuery $(selectQuery selectActivityRelease $ &quot;WHERE slot_release.container = ${containerId $ containerRow cont} AND &quot; ++ activityQual)

  asa &lt;- mapM (addAssetRevision (containerVolume cont)) =&lt;&lt; chainPrev activityAssetId
    &lt;$&gt; dbQuery $(selectQuery selectActivityAssetSlot $ &quot;WHERE slot_asset.container = ${containerId $ containerRow cont} AND &quot; ++ activityQual)

  caa &lt;- mergeAssetCreation . chainPrev (assetId . activityAssetRow)
    &lt;$&gt; dbQuery $(selectQuery selectActivityAsset $ &quot;JOIN slot_asset ON asset.id = slot_asset.asset WHERE slot_asset.container = ${containerId $ containerRow cont} AND &quot; ++ activityQual)
  let uam m Activity{ activityAudit = Audit{ auditAction = AuditActionRemove, auditWhen = t }, activityTarget = ActivityAssetSlot{ activityAssetId = a } } =
        Map.insert a t m
      uam m Activity{ activityAudit = Audit{ auditAction = AuditActionChange, auditWhen = t }, activityReplace = Just ar } =
        Map.insert (assetId $ assetRow ar) t m
      uam m _ = m
      dam = flip $ Map.delete . assetId . activityAssetRow . activityTarget
      oal = Map.toList $ foldl' dam (foldl' uam Map.empty asa) caa
  oaa &lt;- forM oal $ \(ai, at) -&gt;
    mergeAssetCreation . chainPrev (const ())
      &lt;$&gt; dbQuery $(selectQuery selectActivityAsset $ &quot;WHERE asset.id = ${ai} AND audit_time &lt;= ${at} AND &quot; ++ activityQual)

  cea &lt;- chainPrev (activityAssetId &amp;&amp;&amp; activitySegment)
    &lt;$&gt; dbQuery $(selectQuery selectActivityExcerpt $ &quot;JOIN slot_asset ON excerpt.asset = slot_asset.asset WHERE slot_asset.container = ${containerId $ containerRow cont} AND &quot; ++ activityQual)

  return $ mergeAssetAndSlot $ mergeActivities (ca:ra:asa:cea:caa:oaa)

-- EDIT permission assumed for all
activityTargetJSON :: ActivityTarget -&gt; (T.Text, JSON.Object, JSON.Object)
activityTargetJSON (ActivityParty p) =
  (&quot;party&quot;, mempty, JSON.recordObject $
    partyRowJSON p)
activityTargetJSON ActivityAccount{..} =
  (&quot;account&quot;, mempty,
    &quot;email&quot; JSON..= activityAccountEmail &lt;&gt; &quot;password&quot; JSON..= activityAccountPassword)
activityTargetJSON (ActivityAuthorize a) =
  (&quot;authorize&quot;, &quot;party&quot; JSON..=: partyJSON (authorizeChild $ authorization a),
    authorizeJSON a)
activityTargetJSON (ActivityVolume v) =
  (&quot;volume&quot;, mempty, JSON.recordObject $
    volumeRowJSON v JSON..&lt;&gt;
      &quot;alias&quot; JSON..=? volumeAlias v)
activityTargetJSON (ActivityAccess a) =
  (&quot;access&quot;, &quot;party&quot; JSON..=: partyJSON (volumeAccessParty a),
    volumeAccessJSON a)
activityTargetJSON (ActivityContainer c) =
  (&quot;container&quot;, mempty, JSON.recordObject $
    containerRowJSON c JSON..&lt;&gt;
      &quot;date&quot; JSON..=? containerDate c)
activityTargetJSON ActivityRelease{..} =
  (&quot;release&quot;, segmentJSON $ slotSegmentId activitySlotId,
    &quot;release&quot; JSON..= activityRelease)
activityTargetJSON (ActivityAsset a) =
  (&quot;asset&quot;, &quot;id&quot; JSON..= assetId a,
    &quot;classification&quot; JSON..=? assetRelease a &lt;&gt; &quot;name&quot; JSON..=? assetName a)
activityTargetJSON (ActivityAssetSlot a s) =
  (&quot;asset&quot;, &quot;id&quot; JSON..= a,
    segmentJSON $ slotSegmentId s)
activityTargetJSON (ActivityAssetAndSlot a s) = (n, i, o &lt;&gt; segmentJSON (slotSegmentId s)) where
  (n, i, o) = activityTargetJSON (ActivityAsset a)
activityTargetJSON ActivityExcerpt{..} =
  (&quot;excerpt&quot;, &quot;id&quot; JSON..= activityAssetId &lt;&gt; segmentJSON activitySegment,
    &quot;excerpt&quot; JSON..=? activityExcerptRelease)

activityAssetJSON :: Asset -&gt; JSON.Object
activityAssetJSON a = JSON.recordObject $ assetJSON a JSON..&lt;&gt; &quot;name&quot; JSON..=? assetName (assetRow a)

activityJSON :: Activity -&gt; Maybe JSON.Object
activityJSON Activity{ activityAudit = Audit{..}, ..} = auditAction == AuditActionChange &amp;&amp; HM.null new &amp;&amp; HM.null old ?!&gt;
  new &lt;&gt; key
    &lt;&gt; &quot;when&quot; JSON..= auditWhen
    &lt;&gt; &quot;action&quot; JSON..= show (auditAction)
    &lt;&gt; &quot;ip&quot; JSON..= show (auditIp auditIdentity)
    &lt;&gt; &quot;user&quot; JSON..= auditWho auditIdentity
    &lt;&gt; &quot;type&quot; JSON..= typ
    &lt;&gt; &quot;old&quot; JSON..=? (old &lt;!? HM.null old)
    &lt;&gt; &quot;replace&quot; JSON..=? (activityAssetJSON &lt;$&gt; activityReplace)
    &lt;&gt; &quot;transcode&quot; JSON..=? (activityAssetJSON &lt;$&gt; activityTranscode)
  where
  (new, old)
    | auditAction == AuditActionRemove
      = (HM.empty, targ)
    | Just p &lt;- activityPrev
    , (_, _, prev) &lt;- activityTargetJSON p
    , int &lt;- HM.filter id $ HM.intersectionWith (==) targ prev
      = (if auditAction == AuditActionAdd then targ else HM.difference targ int, HM.difference prev int)
    | otherwise
      = (targ, HM.empty)
  (typ, key, targ) = activityTargetJSON activityTarget
</span></pre></body></html>