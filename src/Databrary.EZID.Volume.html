<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RecordWildCards, TemplateHaskell, QuasiQuotes, DataKinds #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">EZID</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.EZID.Volume.html#updateEZID"><span class="hs-identifier hs-var">updateEZID</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Arrow</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;&amp;&amp;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;=&lt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSC</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Function</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">on</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deleteFirstsBy</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">utctDay</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pgSQL</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Wai</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Wai</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Has.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Has</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Service-DB.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Service</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Service-Log.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Service</span><span class="hs-operator">.</span><span class="hs-identifier">Log</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Context.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Time.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Permission.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Permission</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Identity.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Identity</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Id.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Id</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Volume.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-VolumeAccess.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">VolumeAccess</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Citation.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Citation</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Container.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Slot.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Slot</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Funding.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Funding</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Model-Tag.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Tag</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Action-Route.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Action</span><span class="hs-operator">.</span><span class="hs-identifier">Route</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-Controller-Volume.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Controller</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-EZID-API.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">EZID</span><span class="hs-operator">.</span><span class="hs-identifier">API</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="../Databrary-EZID-DataCite.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">EZID</span><span class="hs-operator">.</span><span class="hs-identifier">DataCite</span></a><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-identifier">useTDB</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-identifier">volumeDOISuffix</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-41"></a><a name="volumeDOISuffix"><a href="Databrary.EZID.Volume.html#volumeDOISuffix"><span class="hs-identifier">volumeDOISuffix</span></a></a><span> </span><a name="local-1629939084"><a href="#local-1629939084"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BSC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-char">'.'</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1629939084"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-identifier">volumeEZID</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629939083"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629939082"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Identity.Types.html#MonadHasIdentity"><span class="hs-identifier hs-type">MonadHasIdentity</span></a><span> </span><a href="#local-1629939083"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629939082"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.Citation.Types.html#Citation"><span class="hs-identifier hs-type">Citation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629939082"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Databrary.EZID.API.html#EZIDMeta"><span class="hs-identifier hs-type">EZIDMeta</span></a><span>
</span><a name="line-44"></a><a name="volumeEZID"><a href="Databrary.EZID.Volume.html#volumeEZID"><span class="hs-identifier">volumeEZID</span></a></a><span> </span><a name="local-1629939085"><a href="#local-1629939085"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">@</span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-var">Volume</span></a><span class="hs-special">{</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeRow"><span class="hs-identifier hs-var">volumeRow</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeId"><span class="hs-identifier hs-var">VolumeRow</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-1629939094"><a href="#local-1629939094"><span class="hs-identifier">cite</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-45"></a><span>  </span><a name="local-1629939095"><a href="#local-1629939095"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Container.html#lookupVolumeTopContainer"><span class="hs-identifier hs-var">lookupVolumeTopContainer</span></a><span> </span><a href="#local-1629939085"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-46"></a><span>  </span><a name="local-1629939096"><a href="#local-1629939096"><span class="hs-identifier">own</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.VolumeAccess.html#lookupVolumeAccess"><span class="hs-identifier hs-var">lookupVolumeAccess</span></a><span> </span><a href="#local-1629939085"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="Databrary.Model.Permission.Types.html#PermissionADMIN"><span class="hs-identifier hs-var">PermissionADMIN</span></a><span>
</span><a name="line-47"></a><span>  </span><a name="local-1629939097"><a href="#local-1629939097"><span class="hs-identifier">fund</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Funding.html#lookupVolumeFunding"><span class="hs-identifier hs-var">lookupVolumeFunding</span></a><span> </span><a href="#local-1629939085"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-48"></a><span>  </span><a name="local-1629939098"><a href="#local-1629939098"><span class="hs-identifier">link</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Citation.html#lookupVolumeLinks"><span class="hs-identifier hs-var">lookupVolumeLinks</span></a><span> </span><a href="#local-1629939085"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-49"></a><span>  </span><a name="local-1629939099"><a href="#local-1629939099"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Tag.html#lookupSlotKeywords"><span class="hs-identifier hs-var">lookupSlotKeywords</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Slot.Types.html#containerSlot"><span class="hs-identifier hs-var">containerSlot</span></a><span> </span><a href="#local-1629939095"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Databrary.EZID.API.html#EZIDPublic"><span class="hs-identifier hs-var">EZIDPublic</span></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="Databrary.EZID.API.html#ezidTarget"><span class="hs-identifier hs-var">ezidTarget</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Action.Route.html#actionURI"><span class="hs-identifier hs-var">actionURI</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Wai</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">defaultRequest</span><span class="hs-special">)</span><span> </span><a href="Databrary.Controller.Volume.html#viewVolume"><span class="hs-identifier hs-var">viewVolume</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Action.Route.html#HTML"><span class="hs-identifier hs-var">HTML</span></a><span class="hs-special">,</span><span> </span><a href="#local-1629939086"><span class="hs-identifier hs-var">volumeId</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.API.html#ezidDataCite"><span class="hs-identifier hs-var">ezidDataCite</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.EZID.DataCite.html#DataCite"><span class="hs-identifier hs-var">DataCite</span></a><span>
</span><a name="line-53"></a><span>      </span><span class="hs-special">{</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteDOI"><span class="hs-identifier hs-var">dataCiteDOI</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629939090"><span class="hs-identifier hs-var">volumeDOI</span></a><span>
</span><a name="line-54"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteTitle"><span class="hs-identifier hs-var">dataCiteTitle</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629939087"><span class="hs-identifier hs-var">volumeName</span></a><span>
</span><a name="line-55"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteAuthors"><span class="hs-identifier hs-var">dataCiteAuthors</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Databrary.Model.VolumeAccess.Types.html#volumeAccessParty"><span class="hs-identifier hs-var">volumeAccessParty</span></a><span> </span><a href="#local-1629939096"><span class="hs-identifier hs-var">own</span></a><span>
</span><a name="line-56"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteYear"><span class="hs-identifier hs-var">dataCiteYear</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.Time.html#dateYear"><span class="hs-identifier hs-var">dateYear</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">utctDay</span><span> </span><a href="#local-1629939091"><span class="hs-identifier hs-var">volumeCreation</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteDescription"><span class="hs-identifier hs-var">dataCiteDescription</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629939088"><span class="hs-identifier hs-var">volumeBody</span></a><span>
</span><a name="line-58"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteFunders"><span class="hs-identifier hs-var">dataCiteFunders</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1629939097"><span class="hs-identifier hs-var">fund</span></a><span>
</span><a name="line-59"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCitePublication"><span class="hs-identifier hs-var">dataCitePublication</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.Citation.Types.html#citationURL"><span class="hs-identifier hs-var">citationURL</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="#local-1629939094"><span class="hs-identifier hs-var">cite</span></a><span>
</span><a name="line-60"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteReferences"><span class="hs-identifier hs-var">dataCiteReferences</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="Databrary.Model.Citation.Types.html#citationURL"><span class="hs-identifier hs-var">citationURL</span></a><span> </span><a href="#local-1629939098"><span class="hs-identifier hs-var">link</span></a><span>
</span><a name="line-61"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Databrary.EZID.DataCite.html#dataCiteSubjects"><span class="hs-identifier hs-var">dataCiteSubjects</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Tag.Types.html#tagNameBS"><span class="hs-identifier hs-var">tagNameBS</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Tag.Types.html#tagName"><span class="hs-identifier hs-var">tagName</span></a><span class="hs-special">)</span><span> </span><a href="#local-1629939099"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-62"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-identifier">lookupVolumeDOIs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629939081"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629939080"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-1629939080"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-66"></a><a name="lookupVolumeDOIs"><a href="Databrary.EZID.Volume.html#lookupVolumeDOIs"><span class="hs-identifier">lookupVolumeDOIs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-operator">|!</span><span class="hs-identifier hs-var">SELECT</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">doi</span><span> </span><span class="hs-identifier hs-var">FROM</span><span> </span><span class="hs-identifier hs-var">volume</span><span> </span><span class="hs-identifier hs-var">WHERE</span><span> </span><span class="hs-identifier hs-var">doi</span><span> </span><span class="hs-identifier hs-var">IS</span><span> </span><span class="hs-identifier hs-var">NOT</span><span> </span><span class="hs-identifier hs-var">NULL</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-identifier">addVolumeDOI</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629939079"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629939078"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629939078"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-69"></a><a name="addVolumeDOI"><a href="Databrary.EZID.Volume.html#addVolumeDOI"><span class="hs-identifier">addVolumeDOI</span></a></a><span> </span><a name="local-1629939106"><a href="#local-1629939106"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1629939107"><a href="#local-1629939107"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Service.DB.html#dbExecute1"><span class="hs-identifier hs-var">dbExecute1</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">pgSQL</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">UPDATE</span><span> </span><span class="hs-identifier hs-var">volume</span><span> </span><span class="hs-identifier hs-var">SET</span><span> </span><span class="hs-identifier hs-var">doi</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">d</span><span class="hs-special">}</span><span> </span><span class="hs-identifier hs-var">WHERE</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-special">{</span><span class="hs-identifier hs-var">v</span><span class="hs-special">}</span><span> </span><span class="hs-identifier hs-var">AND</span><span> </span><span class="hs-identifier hs-var">doi</span><span> </span><span class="hs-identifier hs-var">IS</span><span> </span><span class="hs-identifier hs-var">NULL</span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-identifier">updateVolume</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.Citation.Types.html#Citation"><span class="hs-identifier hs-type">Citation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.EZID.API.html#EZIDM"><span class="hs-identifier hs-type">EZIDM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-72"></a><a name="updateVolume"><a href="Databrary.EZID.Volume.html#updateVolume"><span class="hs-identifier">updateVolume</span></a></a><span> </span><a name="local-1629939114"><a href="#local-1629939114"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Databrary.EZID.Volume.html#addVolumeDOI"><span class="hs-identifier hs-var">addVolumeDOI</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeId"><span class="hs-identifier hs-var">volumeId</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeRow"><span class="hs-identifier hs-var">volumeRow</span></a><span> </span><a href="#local-1629939114"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;=&lt;</span><span> </span><a href="Databrary.EZID.API.html#ezidCreate"><span class="hs-identifier hs-var">ezidCreate</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.EZID.Volume.html#volumeDOISuffix"><span class="hs-identifier hs-var">volumeDOISuffix</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeId"><span class="hs-identifier hs-var">volumeId</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeRow"><span class="hs-identifier hs-var">volumeRow</span></a><span> </span><a href="#local-1629939114"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>  </span><a href="Databrary.EZID.API.html#ezidModify"><span class="hs-identifier hs-var">ezidModify</span></a><span>
</span><a name="line-75"></a><span>  </span><span class="hs-special">(</span><a href="Databrary.Model.Volume.Types.html#volumeDOI"><span class="hs-identifier hs-var">volumeDOI</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeRow"><span class="hs-identifier hs-var">volumeRow</span></a><span> </span><a href="#local-1629939114"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-operator hs-var">&lt;=&lt;</span><span> </span><a href="Databrary.EZID.Volume.html#volumeEZID"><span class="hs-identifier hs-var">volumeEZID</span></a><span> </span><a href="#local-1629939114"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-identifier">removeVolume</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Id.Types.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Databrary.EZID.API.html#EZIDM"><span class="hs-identifier hs-type">EZIDM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-79"></a><a name="removeVolume"><a href="Databrary.EZID.Volume.html#removeVolume"><span class="hs-identifier">removeVolume</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1629939115"><a href="#local-1629939115"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.EZID.API.html#ezidModify"><span class="hs-identifier hs-var">ezidModify</span></a><span> </span><a href="#local-1629939115"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="Databrary.EZID.API.html#EZIDUnavailable"><span class="hs-identifier hs-var">EZIDUnavailable</span></a><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-identifier">updateEZID</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Context.html#BackgroundContextM"><span class="hs-identifier hs-type">BackgroundContextM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><a name="updateEZID"><a href="Databrary.EZID.Volume.html#updateEZID"><span class="hs-identifier">updateEZID</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.EZID.API.html#runEZIDM"><span class="hs-identifier hs-var">runEZIDM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-83"></a><span>  </span><a name="local-1629939116"><a href="#local-1629939116"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.EZID.API.html#ezidStatus"><span class="hs-identifier hs-var">ezidStatus</span></a><span>
</span><a name="line-84"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-1629939116"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-85"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>      </span><a name="local-1629939117"><a href="#local-1629939117"><span class="hs-identifier">vl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Citation.html#lookupVolumesCitations"><span class="hs-identifier hs-var">lookupVolumesCitations</span></a><span>
</span><a name="line-87"></a><span>      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Databrary.EZID.Volume.html#updateVolume"><span class="hs-identifier hs-var">updateVolume</span></a><span class="hs-special">)</span><span> </span><a href="#local-1629939117"><span class="hs-identifier hs-var">vl</span></a><span>
</span><a name="line-88"></a><span>      </span><a name="local-1629939118"><a href="#local-1629939118"><span class="hs-identifier">dl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.EZID.Volume.html#lookupVolumeDOIs"><span class="hs-identifier hs-var">lookupVolumeDOIs</span></a><span>
</span><a name="line-89"></a><span>      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Databrary.EZID.Volume.html#removeVolume"><span class="hs-identifier hs-var">removeVolume</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-90"></a><span>        </span><span class="hs-identifier hs-var">deleteFirstsBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">on</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-1629939118"><span class="hs-identifier hs-var">dl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Databrary.Model.Volume.Types.html#volumeId"><span class="hs-identifier hs-var">volumeId</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeDOI"><span class="hs-identifier hs-var">volumeDOI</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.Volume.Types.html#volumeRow"><span class="hs-identifier hs-var">volumeRow</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-1629939117"><span class="hs-identifier hs-var">vl</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-92"></a><span>      </span><a name="local-1629939119"><a href="#local-1629939119"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-93"></a><span>      </span><a href="Databrary.Has.html#focusIO"><span class="hs-identifier hs-var">focusIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Service.Log.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a><span> </span><a href="#local-1629939119"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-string">&quot;ezid is down&quot;</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-1629939116"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-95"></a></pre></body></html>