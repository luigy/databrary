<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Tag</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.Tag.SQL.html#selectTag"><span class="hs-identifier hs-var">selectTag</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.SQL.html#selectTagUseRow"><span class="hs-identifier hs-var">selectTagUseRow</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.SQL.html#insertTagUse"><span class="hs-identifier hs-var">insertTagUse</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.SQL.html#deleteTagUse"><span class="hs-identifier hs-var">deleteTagUse</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.SQL.html#selectTagWeight"><span class="hs-identifier hs-var">selectTagWeight</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.SQL.html#selectTagCoverage"><span class="hs-identifier hs-var">selectTagCoverage</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Tag.SQL.html#selectSlotTagCoverage"><span class="hs-identifier hs-var">selectSlotTagCoverage</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">PostgreSQL</span><span class="hs-operator">.</span><span class="hs-identifier">Typed</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makePGQuery</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">simpleQueryFlags</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.SQL.Select.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span><span class="hs-operator">.</span><span class="hs-identifier">Select</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Id.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Id</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Party.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Party</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Container.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Segment.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Segment</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Slot.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Slot</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Tag.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Tag</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-identifier">tagRow</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.SQL.Select.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span> </span><span class="hs-comment">-- ^ @'Tag'@</span><span>
</span><a name="line-26"></a><a name="tagRow"><a href="Databrary.Model.Tag.SQL.html#tagRow"><span class="hs-identifier">tagRow</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Databrary.Model.SQL.Select.html#selectColumns"><span class="hs-identifier hs-var">selectColumns</span></a><span> </span><span class="hs-char">'Tag &quot;tag&quot; [&quot;id&quot;, &quot;name&quot;]

selectTag :: Selector -- ^ @'Tag'@
selectTag = tagRow

tagUseTable :: Bool -&gt; String
tagUseTable False = &quot;tag_use&quot;
tagUseTable True = &quot;keyword_use&quot;

makeTagUseRow :: Id Party -&gt; Id Container -&gt; Segment -&gt; Maybe Bool -&gt; Tag -&gt; TagUseRow
makeTagUseRow w c s k t = TagUseRow t (fromMaybe False k) w (SlotId c s)

tagUseRow :: Selector -- ' @'Tag' -&gt; 'TagUseRow'@
tagUseRow = addSelects '($)
  (selectColumns 'makeTagUseRow &quot;tag_use&quot; [&quot;who&quot;, &quot;container&quot;, &quot;segment&quot;])
  [SelectExpr &quot;tag_use.tableoid = 'keyword_use'::regclass&quot;]

selectTagUseRow :: Selector -- ^ @'TagUseId'@
selectTagUseRow = selectJoin '($)
  [ tagUseRow
  , joinOn &quot;tag_use.tag = tag.id&quot;
    tagRow
  ]

insertTagUse :: Bool -- ^ keyword
  -&gt; TH.Name -- ^ @'TagUse'@
  -&gt; TH.ExpQ
insertTagUse keyword o = makePGQuery simpleQueryFlags $
  &quot;INSERT INTO &quot; ++ tagUseTable keyword ++ &quot; (tag, container, segment, who) VALUES (${tagId $ useTag &quot; ++ os ++ &quot;}, ${containerId $ containerRow $ slotContainer $ tagSlot  &quot; ++ os ++ &quot;}, ${slotSegment $ tagSlot  &quot; ++ os ++ &quot;}, ${partyId $ partyRow $ accountParty $ tagWho  &quot; ++ os ++ &quot;})&quot;
  where os = nameRef o

deleteTagUse :: Bool -- ^ keyword
  -&gt; TH.Name -- ^ @'TagUse'@
  -&gt; TH.ExpQ
deleteTagUse keyword o = makePGQuery simpleQueryFlags $
  &quot;DELETE FROM ONLY &quot; ++ tagUseTable keyword ++ &quot; WHERE tag = ${tagId $ useTag &quot; ++ os ++ &quot;} AND container = ${containerId $ containerRow $ slotContainer $ tagSlot &quot; ++ os ++ &quot;} AND segment &lt;@ ${slotSegment $ tagSlot &quot; ++ os ++ &quot;}&quot;
  ++ (if keyword then &quot;&quot; else &quot; AND who = ${partyId $ partyRow $ accountParty $ tagWho &quot; ++ os ++ &quot;}&quot;)
  where os = nameRef o

selectTagGroup :: String -- ^ table name
  -&gt; String -- ^ query
  -&gt; TH.Name -- ^ make function
  -&gt; [(String, String)] -- ^ select columns (alias, select)
  -&gt; Selector
selectTagGroup name q make cols = selector
  (&quot;(SELECT tag,&quot; ++ intercalate &quot;,&quot; (map (\(a, s) -&gt; s ++ &quot; AS &quot; ++ a) cols)
    ++ &quot; FROM tag_use &quot; ++ q ++ &quot; GROUP BY tag) AS &quot; ++ name)
  $ OutputJoin False make $ map (SelectColumn name . fst) cols

tagWeightColumns :: [(String, String)]
tagWeightColumns =
  [ (&quot;weight&quot;, &quot;count(*)::integer&quot;)
  ]

makeTagWeight :: Int32 -&gt; Tag -&gt; TagWeight
makeTagWeight w t = TagWeight t w

selectTagWeight :: String -&gt; Selector -- ^ @'TagCoverage'@
selectTagWeight q = selectJoin '($)
  [ selectTagGroup &quot;tag_weight&quot; q 'makeTagWeight tagWeightColumns
  , joinOn &quot;tag_weight.tag = tag.id&quot; selectTag
  ]

makeTagCoverage :: Int32 -&gt; [Maybe Segment] -&gt; [Maybe Segment] -&gt; [Maybe Segment] -&gt; Tag -&gt; Container -&gt; TagCoverage
makeTagCoverage w s k v t c = TagCoverage (TagWeight t w) c (segs s) (segs k) (segs v) where
  segs = map $ fromMaybe (error &quot;NULL tag segment&quot;)

tagCoverageColumns :: TH.Name -- ^ @'Party'@
  -&gt; [(String, String)]
tagCoverageColumns acct = tagWeightColumns ++
  [ (&quot;coverage&quot;, &quot;segments_union(segment)&quot;)
  , (&quot;keywords&quot;, &quot;segments_union(CASE WHEN tableoid = 'keyword_use'::regclass THEN segment ELSE 'empty' END)&quot;)
  , (&quot;votes&quot;, &quot;segments_union(CASE WHEN tableoid = 'tag_use'::regclass AND who = ${partyId $ partyRow &quot; ++ nameRef acct ++ &quot;} THEN segment ELSE 'empty' END)&quot;)
  ]

selectTagCoverage :: TH.Name -- ^ @'Party'@
  -&gt; String -- ^ query
  -&gt; Selector -- ^ @'Tag' -&gt; 'Container' -&gt; 'TagCoverage'@
selectTagCoverage acct q =
  selectTagGroup &quot;tag_coverage&quot; q 'makeTagCoverage $ tagCoverageColumns acct

selectSlotTagCoverage :: TH.Name -- ^ @'Party'@
  -&gt; TH.Name -- ^ @'Slot'
  -&gt; Selector -- ^ @'TagCoverage'@
selectSlotTagCoverage acct slot = selectMap (`TH.AppE` (TH.VarE 'slotContainer `TH.AppE` TH.VarE slot)) $ selectJoin '($)
  [ selectTagCoverage acct $ &quot;WHERE container = ${containerId $ containerRow $ slotContainer &quot; ++ ss ++ &quot;} AND segment &amp;&amp; ${slotSegment &quot; ++ ss ++ &quot;}&quot;
  , joinOn &quot;tag_coverage.tag = tag.id&quot; selectTag
  ] where ss = nameRef slot
</span></pre></body></html>