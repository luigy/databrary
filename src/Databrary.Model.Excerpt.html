<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, TemplateHaskell, RecordWildCards, DataKinds #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Excerpt</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Databrary.Model.Excerpt.html#lookupAssetExcerpts"><span class="hs-identifier hs-var">lookupAssetExcerpts</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Excerpt.html#lookupSlotExcerpts"><span class="hs-identifier hs-var">lookupSlotExcerpts</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Excerpt.html#lookupVolumeExcerpts"><span class="hs-identifier hs-var">lookupVolumeExcerpts</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Excerpt.html#lookupSlotThumb"><span class="hs-identifier hs-var">lookupSlotThumb</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Excerpt.html#lookupVolumeThumb"><span class="hs-identifier hs-var">lookupVolumeThumb</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Excerpt.html#changeExcerpt"><span class="hs-identifier hs-var">changeExcerpt</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Excerpt.html#removeExcerpt"><span class="hs-identifier hs-var">removeExcerpt</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Databrary.Model.Excerpt.html#excerptJSON"><span class="hs-identifier hs-var">excerptJSON</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">guard</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Has.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Has</span></a><span> </span><span class="hs-special">(</span><a href="Databrary.Has.html#view"><span class="hs-identifier hs-var">view</span></a><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Databrary.JSON.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">JSON</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">JSON</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Service.DB.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Service</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Permission.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Permission</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Audit.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Audit</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Volume.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Volume</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Container.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Container</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Slot.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Slot</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Asset.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Asset</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.AssetSlot.Types.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">AssetSlot</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.AssetSegment.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">AssetSegment</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Databrary.Model.Excerpt.SQL.html"><span class="hs-identifier">Databrary</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span class="hs-operator">.</span><span class="hs-identifier">Excerpt</span><span class="hs-operator">.</span><span class="hs-identifier">SQL</span></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-identifier">lookupAssetExcerpts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629183136"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629183135"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.AssetSlot.Types.html#AssetSlot"><span class="hs-identifier hs-type">AssetSlot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629183135"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.AssetSegment.Types.html#Excerpt"><span class="hs-identifier hs-type">Excerpt</span></a><span class="hs-special">]</span><span>
</span><a name="line-30"></a><a name="lookupAssetExcerpts"><a href="Databrary.Model.Excerpt.html#lookupAssetExcerpts"><span class="hs-identifier">lookupAssetExcerpts</span></a></a><span> </span><a name="local-1629183137"><a href="#local-1629183137"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-31"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1629183137"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectAssetSlotExcerpt</span><span> </span><span class="hs-string">&quot;$WHERE excerpt.asset = ${assetId $ assetRow $ slotAsset a}&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-identifier">lookupSlotExcerpts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629183134"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629183133"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Slot.Types.html#Slot"><span class="hs-identifier hs-type">Slot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629183133"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.AssetSegment.Types.html#Excerpt"><span class="hs-identifier hs-type">Excerpt</span></a><span class="hs-special">]</span><span>
</span><a name="line-34"></a><a name="lookupSlotExcerpts"><a href="Databrary.Model.Excerpt.html#lookupSlotExcerpts"><span class="hs-identifier">lookupSlotExcerpts</span></a></a><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Slot.Types.html#Slot"><span class="hs-identifier hs-var">Slot</span></a><span> </span><a name="local-1629183148"><a href="#local-1629183148"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-1629183149"><a href="#local-1629183149"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-35"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1629183148"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectContainerExcerpt</span><span> </span><span class="hs-string">&quot;$WHERE slot_asset.container = ${containerId $ containerRow c} AND excerpt.segment &amp;&amp; ${s}&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-identifier">lookupVolumeExcerpts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629183132"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629183131"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629183131"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Databrary.Model.AssetSegment.Types.html#Excerpt"><span class="hs-identifier hs-type">Excerpt</span></a><span class="hs-special">]</span><span>
</span><a name="line-38"></a><a name="lookupVolumeExcerpts"><a href="Databrary.Model.Excerpt.html#lookupVolumeExcerpts"><span class="hs-identifier">lookupVolumeExcerpts</span></a></a><span> </span><a name="local-1629183177"><a href="#local-1629183177"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-39"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery"><span class="hs-identifier hs-var">dbQuery</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1629183177"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectVolumeExcerpt</span><span> </span><span class="hs-string">&quot;$WHERE asset.volume = ${volumeId $ volumeRow v}&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-identifier">lookupSlotThumb</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629183130"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629183129"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Slot.Types.html#Slot"><span class="hs-identifier hs-type">Slot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629183129"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.AssetSegment.Types.html#AssetSegment"><span class="hs-identifier hs-type">AssetSegment</span></a><span class="hs-special">)</span><span>
</span><a name="line-42"></a><a name="lookupSlotThumb"><a href="Databrary.Model.Excerpt.html#lookupSlotThumb"><span class="hs-identifier">lookupSlotThumb</span></a></a><span> </span><span class="hs-special">(</span><a href="Databrary.Model.Slot.Types.html#Slot"><span class="hs-identifier hs-var">Slot</span></a><span> </span><a name="local-1629183214"><a href="#local-1629183214"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-1629183215"><a href="#local-1629183215"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-43"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery1"><span class="hs-identifier hs-var">dbQuery1</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Model.AssetSegment.html#assetSegmentInterp"><span class="hs-identifier hs-var">assetSegmentInterp</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.AssetSegment.Types.html#excerptAsset"><span class="hs-identifier hs-var">excerptAsset</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1629183214"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectContainerExcerpt</span><span> </span><span class="hs-string">&quot;$\
    \JOIN format ON asset.format = format.id \
    \WHERE slot_asset.container = ${containerId $ containerRow c} AND excerpt.segment &amp;&amp; ${s} \
      \AND COALESCE(GREATEST(excerpt.release, asset.release), ${containerRelease c}) &gt;= ${readRelease (view c)}::release \
      \AND (asset.duration IS NOT NULL AND format.mimetype LIKE 'video/%' OR format.mimetype LIKE 'image/%') \
      \AND asset.sha1 IS NOT NULL \
    \LIMIT 1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">lookupVolumeThumb</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Service.DB.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a><span> </span><a href="#local-1629183128"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629183127"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.Volume.Types.html#Volume"><span class="hs-identifier hs-type">Volume</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629183127"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Databrary.Model.AssetSegment.Types.html#AssetSegment"><span class="hs-identifier hs-type">AssetSegment</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><a name="lookupVolumeThumb"><a href="Databrary.Model.Excerpt.html#lookupVolumeThumb"><span class="hs-identifier">lookupVolumeThumb</span></a></a><span> </span><a name="local-1629183245"><a href="#local-1629183245"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-53"></a><span>  </span><a href="Databrary.Service.DB.html#dbQuery1"><span class="hs-identifier hs-var">dbQuery1</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Databrary.Model.AssetSegment.html#assetSegmentInterp"><span class="hs-identifier hs-var">assetSegmentInterp</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.AssetSegment.Types.html#excerptAsset"><span class="hs-identifier hs-var">excerptAsset</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1629183245"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">selectQuery</span><span> </span><span class="hs-identifier hs-var">selectVolumeExcerpt</span><span> </span><span class="hs-string">&quot;$\
    \JOIN format ON asset.format = format.id \
    \WHERE asset.volume = ${volumeId $ volumeRow v} \
      \AND COALESCE(GREATEST(excerpt.release, asset.release), slot_release.release) &gt;= ${readRelease (view v)}::release \
      \AND (asset.duration IS NOT NULL AND format.mimetype LIKE 'video/%' OR format.mimetype LIKE 'image/%') \
      \AND asset.sha1 IS NOT NULL \
    \ORDER BY container.top DESC LIMIT 1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-identifier">changeExcerpt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Databrary.Model.Audit.html#MonadAudit"><span class="hs-identifier hs-type">MonadAudit</span></a><span> </span><a href="#local-1629183126"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-1629183125"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Databrary.Model.AssetSegment.Types.html#Excerpt"><span class="hs-identifier hs-type">Excerpt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1629183125"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-62"></a><a name="changeExcerpt"><a href="Databrary.Model.Excerpt.html#changeExcerpt"><span class="hs-identifier">changeExcerpt</span></a></a><span> </span><a name="local-1629183283"><a href="#local-1629183283"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-63"></a><span>  </span><a name="local-1629183284"><a href="#local-1629183284"><span class="hs-identifier">ident</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Databrary.Model.Audit.html#getAuditIdentity"><span class="hs-identifier hs-var">getAuditIdentity</span></a><span>
</span><a name="line-64"></a><span>  </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Databrary.Model.SQL.html#tryUpdateOrInsert"><span class="hs-identifier hs-var">tryUpdateOrInsert</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Databrary.Model.SQL.html#isExclusionViolation"><span class="hs-identifier hs-var">isExclusionViolation</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>    </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">updateExcerpt</span><span> </span><span class="hs-char">'ident 'e)
    $(insertExcerpt 'ident 'e)

removeExcerpt :: MonadAudit c m =&gt; AssetSegment -&gt; m Bool
removeExcerpt e = do
  ident &lt;- getAuditIdentity
  dbExecute1 $(deleteExcerpt 'ident 'e)

excerptJSON :: JSON.ToObject o =&gt; Excerpt -&gt; o
excerptJSON = assetSegmentJSON . excerptAsset
</span></pre></body></html>